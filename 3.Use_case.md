UC-01: Link Wallet (Web3) + Xác minh OTP + Nonce (Link Wallet)
Use case này là liên kết ví Web3 (MetaMask, WalletConnect…) vào tài khoản và xác minh người sở hữu ví bằng chữ ký + OTP.
Mục tiêu
Liên kết địa chỉ ví vào user một cách an toàn: OTP (xác minh kênh) + nonce (chống replay).
Tác nhân
•	Người dùng
•	Web/App (dApp)
•	Ví Web3 (MetaMask/WalletConnect…)
•	Backend
Tiền điều kiện
•	Người dùng đang ở trạng thái đã định danh đủ mức yêu cầu (tuỳ policy).
•	Backend có cơ chế phát OTP (SMS/Email/Authenticator).
Luồng chính
1.	Người dùng chọn Link Your Wallet.
2.	App gọi Backend lấy challenge:
o	GET /wallet/connect/challenge?address=0x...
3.	Backend tạo nonce (ngẫu nhiên, một lần), TTL và trả về payload ký (EIP-191 / EIP-712).
4.	App yêu cầu ví ký message chứa: address + nonce + issuedAt + domain + chainId (và có thể scope).
5.	Người dùng nhận OTP (SMS/Email/Authenticator) và nhập OTP trên App.
6.	App gọi API liên kết ví:
o	POST /wallet/connect
o	Payload: address, signature, nonce, otp, (tuỳ chọn otpRef/otpSessionId).
7.	Backend xác minh:
o	Verify OTP (đúng, chưa hết hạn, đúng session).
o	Verify nonce (tồn tại, chưa dùng, chưa hết hạn, đúng address).
o	Verify chữ ký (signature khớp address và message).
8.	Backend lưu DB:
o	Tạo/Update liên kết user_id ↔ wallet_address, lưu trạng thái VERIFIED.
o	Đánh dấu nonce “đã dùng” (invalidate).
9.	Backend trả kết quả thành công.

Ngoại lệ
•	E1: OTP sai/hết hạn → từ chối, cho phép gửi lại OTP theo hạn mức.
•	E2: Nonce hết hạn/đã dùng → yêu cầu tạo challenge mới.
•	E3: Signature không hợp lệ → từ chối liên kết.

UC-03: Login bằng ví đã Import (EVM Login: Nonce + Deadline)
Mục tiêu
Đăng nhập không cần mật khẩu bằng cách ký message: nonce + deadline (chống replay + chống ký vô hạn).
Tác nhân
•	Người dùng
•	App
•	Wallet (imported wallet)
•	Backend Auth Service

Tiền điều kiện
•	User đã có wallet được import và trạng thái ACTIVE.
•	Backend hỗ trợ issuing nonce và validate deadline.

Luồng chính
1.	App gọi Backend xin challenge login:
o	GET /auth/evm/challenge?address=0x...
2.	Backend sinh:
o	nonce, deadline (timestamp hết hạn), issuedAt, domain, chainId.
o	Lưu challenge vào store (DB/Redis) với TTL.
3.	App dùng wallet imported để ký message (EIP-191/EIP-712) chứa nonce + deadline + domain.
4.	App gọi API login:
o	POST /auth/evm/login
o	Payload: address, signature, nonce, deadline
5.	Backend xác minh:
o	Challenge tồn tại, nonce chưa dùng, chưa hết hạn.
o	Deadline hợp lệ (chưa quá hạn).
o	Signature hợp lệ cho address.
6.	Backend tạo session/token (JWT/refresh token), trả về cho App.
7.	Backend invalidate nonce/challenge.
Ngoại lệ
•	E1: Deadline quá hạn → yêu cầu lấy challenge mới.
•	E2: Nonce đã dùng → từ chối (replay detected).
•	E3: Wallet chưa link/import → trả lỗi “wallet not registered”.
Hậu điều kiện
•	User đăng nhập thành công bằng ví, nhận token truy cập.

UC-04A1: Buy CDS – User ký transaction trực tiếp + OTP/2FA
User tự ký tx gọi function buy(...), nhưng backend chỉ gửi lên chain sau khi OTP/2FA pass.
Main Flow
1.	User tạo lệnh mua
o	User nhập amount/product và bấm “Mua CDS”.
2.	Backend tạo “purchase intent” + phát OTP
o	App gọi POST /cds/buy/intents
o	Backend:
	Validate nghiệp vụ sơ bộ (KYC, hạn mức, sản phẩm hợp lệ).
	Tạo purchase_intent trạng thái OTP_REQUIRED, sinh intent_id, TTL.
	Gửi OTP/2FA challenge (SMS/Email/TOTP).
o	Backend trả về: intent_id, thông tin cần ký (domain, chainId, contract, amount…), otp_session_id.
3.	User ký giao dịch
o	App build calldata buy(...).
o	Wallet ký rawTx (hoặc ký typed-data để backend build tx).
4.	User nhập OTP/2FA
o	User nhập OTP (hoặc TOTP) trên App.
5.	Submit giao dịch kèm OTP
o	App gọi POST /cds/buy/submit
o	Payload tối thiểu:
	intent_id, otp_code (hoặc totp_code), otp_session_id
	address, rawTx (hoặc signature + txData)
6.	Backend verify
o	Verify access token (đăng nhập).
o	Verify OTP/2FA:
	đúng session, chưa hết hạn, chưa dùng.
o	Verify intent_id:
	còn hiệu lực, đúng user, đúng amount/product (khớp intent).
o	Verify transaction:
	đúng contract address, đúng method buy, đúng params, đúng chainId.
7.	Broadcast
o	Backend gọi Relayer Service để đẩy tx lên blockchain.
8.	Lưu giao dịch & trạng thái
o	Tạo transaction record: PENDING + tx_hash.
o	Invalidate OTP + intent (không dùng lại).
9.	Theo dõi kết quả
o	Update CONFIRMED/FAILED theo receipt.
Exception / Alternative Flows
•	E1: OTP sai/hết hạn → giữ intent ở OTP_REQUIRED (cho phép resend theo rate limit).
•	E2: Intent hết hạn → yêu cầu tạo intent mới.
•	E3: TxData không khớp intent (amount/product khác) → reject “Mismatched intent”.
•	E4: Relayer fail → FAILED_BROADCAST (+ retry policy).
•	E5: On-chain revert → FAILED_ONCHAIN (lưu revert reason nếu có).

UC-04A2: Buy CDS – User gửi “Yêu cầu mua” + OTP/2FA + backend ký & relayer
User chỉ tạo request; backend kiểm tra, yêu cầu OTP/2FA, sau đó mới ký giao dịch qua Signing Service và broadcast.
Main Flow
1.	User tạo purchase request
o	App gọi POST /cds/buy/request với amount/product.
2.	Backend validate + phát OTP
o	Backend:
	Validate nghiệp vụ (KYC, hạn mức, risk score, sản phẩm).
	Tạo purchase_request trạng thái OTP_REQUIRED.
	Gửi OTP/2FA challenge; trả về request_id, otp_session_id.
3.	User nhập OTP/2FA để confirm
o	App gọi POST /cds/buy/confirm-otp
o	Payload: request_id, otp_code/totp_code, otp_session_id.
4.	Backend verify OTP & “lock” request
o	Verify OTP hợp lệ.
o	Chuyển purchase_request → APPROVED (hoặc PROCESSING).
o	Invalidate OTP/session.
5.	Backend build tx
o	Backend build calldata buy(...) theo request.
6.	Signing
o	Backend gọi Wallet Service ký transactions
7.	Broadcast
o	Backend gọi Relayer Service gửi tx lên chain.
8.	Lưu transaction
o	Tạo record transaction trạng thái PENDING, liên kết request_id, lưu tx_hash.
9.	Theo dõi & cập nhật
o	Confirm: CONFIRMED và cập nhật purchase_request=COMPLETED.
o	Fail: FAILED_* và cập nhật purchase_request=FAILED.
Exception / Alternative Flows
•	E1: OTP sai/hết hạn → purchase_request vẫn OTP_REQUIRED, cho phép resend.
•	E2: Request bị chặn compliance → REJECTED.
•	E3: Signing Service lỗi/từ chối → FAILED_SIGNING.
•	E4: Relayer fail → FAILED_BROADCAST (retry).
•	E5: On-chain revert → FAILED_ONCHAIN.
Postconditions
•	Nếu thành công: giao dịch được thực thi và request đóng trạng thái hoàn tất; OTP không dùng lại.
•	Bắt buộc OTP theo điều kiện:
o	Luôn bắt buộc, hoặc chỉ khi amount > threshold, hoặc risk_score cao, hoặc “new device/new IP”.
•	TTL OTP: ví dụ 2–5 phút.
•	Rate limit resend: ví dụ 3 lần/10 phút.
•	Idempotency: intent_id/request_id + idempotency_key để tránh double submit.
•	Audit log: lưu otp_verified_at, otp_method, device_fingerprint, ip.

UC-ADM-01: Quản lý lô phát hành CDS (Admin Issuance Batch Management)

Mục tiêu

Admin tạo và quản lý lô phát hành (issuance batch) cho sản phẩm CDS token hoá: cấu hình thông tin lô, hạn mức, thời gian bán, trạng thái, phê duyệt và (tuỳ kiến trúc) phát hành on-chain / đồng bộ off-chain.

Actors
•	Admin (Issuer Admin / Operator)
•	Hệ thống Admin Portal
•	Backend (Issuance Service / CDS Service)
•	AuthZ/RBAC Service (phân quyền)
•	Relayer + Blockchain (nếu có mint/issuance on-chain)

Tiền điều kiện
•	Admin đăng nhập thành công.
•	Admin có quyền: ISSUANCE_BATCH_MANAGE (create/update/approve/publish/close…).
•	Sản phẩm CDS/Asset template đã tồn tại (mã sản phẩm, kỳ hạn, lãi suất…).
 
UC-ADM-01A: Tạo lô phát hành

Dữ liệu lô phát hành (ví dụ)
•	batch_code (mã lô), product_id
•	issue_date, sale_start_at, sale_end_at
•	total_volume (tổng khối lượng phát hành), min_buy, max_buy_per_user
•	price/par_value, currency (VND, stable…)
•	interest_rate, tenor, maturity_date
•	Rule bán: kyc_level_required, allowlist/denylist, region, investor_type
•	settlement_mode: off-chain / on-chain
•	notes, tài liệu đính kèm

Main Flow
1.	Admin vào màn hình Lô phát hành → Tạo mới.
2.	Admin nhập thông tin lô, rule bán, thời gian bán.
3.	Portal gọi API POST /admin/issuance-batches.
4.	Backend:
o	Validate dữ liệu (logic ngày, hạn mức, volume > 0, max ≥ min…).
o	Kiểm tra trùng batch_code.
o	Tạo bản ghi issuance_batch trạng thái DRAFT.
5.	Backend trả batch_id + trạng thái DRAFT.
6.	Portal hiển thị chi tiết lô.

Exception
•	E1: Trùng mã lô → báo lỗi.
•	E2: Thời gian bán không hợp lệ (end < start) → báo lỗi validation.

Postconditions
•	Lô phát hành được tạo ở trạng thái DRAFT, chưa mở bán.

UC-ADM-01B: Cập nhật lô phát hành (Draft/Pre-sale)

Main Flow
1.	Admin mở lô DRAFT và chọn Chỉnh sửa.
2.	Admin cập nhật thông tin (volume, thời gian, rule…).
3.	Portal gọi PUT /admin/issuance-batches/{batch_id}.
4.	Backend validate và cập nhật.
5.	Ghi audit log: ai sửa, sửa gì, thời điểm.

Rules gợi ý
•	Chỉ cho sửa tự do khi DRAFT.
•	Khi đã ON_SALE, chỉ cho sửa “mềm” (notes, allowlist) tuỳ policy.
UC-ADM-01C: Gửi phê duyệt / Phê duyệt lô phát hành (4-eyes)

Khuyến nghị có luồng maker-checker.

Main Flow (Maker gửi duyệt)
1.	Maker chọn Gửi phê duyệt.
2.	Portal gọi POST /admin/issuance-batches/{id}/submit.
3.	Backend chuyển trạng thái: DRAFT → PENDING_APPROVAL.

Main Flow (Checker phê duyệt)
1.	Checker xem chi tiết + checklist rủi ro/compliance.
2.	Checker chọn Approve hoặc Reject.
3.	Portal gọi:
o	Approve: POST /admin/issuance-batches/{id}/approve
o	Reject: POST /admin/issuance-batches/{id}/reject kèm lý do
4.	Backend:
o	Approve: PENDING_APPROVAL → APPROVED
o	Reject: PENDING_APPROVAL → REJECTED + lưu reason

Exception
•	E1: Không đủ quyền checker → 403.
•	E2: Batch thay đổi sau submit (version mismatch) → yêu cầu submit lại.


UC-ADM-01D: Publish/Mở bán lô phát hành

Main Flow
1.	Admin chọn Mở bán (Publish/Start Sale).
2.	Portal gọi POST /admin/issuance-batches/{id}/publish.
3.	Backend kiểm tra:
o	batch đã APPROVED
o	thời gian bán hợp lệ
o	volume và rule hợp lệ
4.	Backend thực hiện publish:
o	Off-chain mode: bật trạng thái bán trong DB/cache.
o	On-chain mode (tuỳ chọn):
	gọi Relayer thực hiện mint/allocate hoặc “create issuance” trên contract
	lưu onchain_tx_hash, contract_address, batch_onchain_id
5.	Chuyển trạng thái: APPROVED → ON_SALE (hoặc SCHEDULED nếu sale_start_at tương lai).
6.	Portal hiển thị lô đang mở bán.

Exception
•	E1: On-chain tx fail → PUBLISH_FAILED và lưu lỗi.
•	E2: Batch chưa approve → chặn.
UC-ADM-01E: Theo dõi tiến độ bán & Quản lý hạn mức

Main Flow
1.	Admin xem dashboard lô: sold_volume, remaining, số đơn mua, tỷ lệ fail, pending.
2.	Admin có thể thao tác:
o	Tăng/giảm max_buy_per_user (tuỳ policy)
o	Tạm dừng bán (Pause)
o	Mở lại (Resume)
3.	Portal gọi các API tương ứng:
o	POST /admin/issuance-batches/{id}/pause
o	POST /admin/issuance-batches/{id}/resume
4.	Backend cập nhật trạng thái:
o	ON_SALE ↔ PAUSED

Exception
•	E1: Pause khi đã close → chặn.
•	E2: Resume khi hết hàng → chặn hoặc chuyển “SOLD_OUT”.
 
UC-ADM-01F: Đóng lô phát hành / Kết thúc bán

Main Flow
1.	Admin chọn Đóng lô (hoặc hệ thống tự đóng khi hết thời gian/hết volume).
2.	Backend chuyển trạng thái:
o	ON_SALE → CLOSED hoặc SOLD_OUT (nếu sold_volume == total_volume)
3.	(Tuỳ chọn) Nếu có on-chain settlement:
o	finalize issuance, snapshot danh sách người mua, khoá allocation.

Postconditions
•	Lô không nhận mua mới.
•	Báo cáo cuối kỳ được chốt.
UC-ADM-01G: Huỷ lô phát hành (Cancel)

Điều kiện
•	Chỉ cho huỷ khi DRAFT hoặc PENDING_APPROVAL (hoặc APPROVED nhưng chưa mở bán), tuỳ policy.

Main Flow
1.	Admin chọn Huỷ lô và nhập lý do.
2.	Portal gọi POST /admin/issuance-batches/{id}/cancel.
3.	Backend:
o	Validate trạng thái cho phép huỷ.
o	Chuyển → CANCELED, lưu reason.
 
Trạng thái đề xuất cho Issuance Batch (State machine)
•	DRAFT
•	PENDING_APPROVAL
•	REJECTED
•	APPROVED
•	SCHEDULED (sale_start_at tương lai)
•	ON_SALE
•	PAUSED
•	SOLD_OUT
•	CLOSED
•	CANCELED
•	PUBLISH_FAILED (nếu on-chain publish lỗi)
