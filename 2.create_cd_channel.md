# 2. Luồng phát hành CDS qua Channel

## Các bước thực hiện

### 1. User gửi yêu cầu phát hành

User chọn:
- amount
- tenor (kỳ hạn)
- loại sản phẩm CDS

### 2. Contract lock stablecoin

Contract thực hiện lock số lượng stablecoin tương ứng từ user.

### 3. Channel gọi MS-CDS

Sau khi lock thành công:
- Channel gửi confirmLock + txHash vào MS-CDS

### 4. MS-CDS phát hành

MS-CDS thực hiện:
- Validate dữ liệu
- Tạo CDS
- Auto approve (do phát hành qua kênh)

### 5. Hạch toán Core Accounting

Core ledger ghi:
- Dr stablecoin pool
- Cr account phát hành CDS

**Lưu ý**: Nếu lỗi hạch toán → rollback nghiệp vụ (contract vẫn lock)

### 6. Chuyển stablecoin sang ví CDS

MS-CDS yêu cầu Issuance Contract trả stablecoin vào ví CDS/custodian wallet.

### 7. Trả kết quả cho User

User thấy:
- Thông tin CDS
- Ngày đáo hạn
- Lãi suất
- txHash lock
- txHash release
## Flowchart Diagram

```mermaid
flowchart TD

    %% ============================
    %% LAYER 1 — CHANNEL / USER
    %% ============================
    A[User gửi yêu cầu phát hành CDS] --> B[Gửi request lên Issuance Contract]

    %% ============================
    %% LAYER 2 — ISSUANCE CONTRACT
    %% ============================
    B --> C{Lock stablecoin VND thành công?}

    C -->|Không| F[Trả lỗi về Channel\nHiển thị lỗi cho user]
    C -->|Có| D[Trả txHash lock token về Channel]

    %% Bước tiếp theo gọi MS-CDS
    D --> E[Gửi confirmLock + txHash\nsang MS-CDS]

    %% ============================
    %% LAYER 3 — MS-CDS (CORE LOGIC)
    %% ============================
    E --> G[Validate dữ liệu CDS]
    G --> H[Tạo CDS]
    H --> I[Auto-Approve CDS]

    %% ============================
    %% LAYER 4 — CORE ACCOUNTING
    %% ============================
    I --> J[Hạch toán phát hành CDS\nDr stablecoin ledger / Cr phát hành]
    J --> K{Hạch toán OK?}

    K -->|Không| F2[Trả lỗi phát hành CDS]
    K -->|Có| L[Gọi Contract để release stablecoin]

    %% ============================
    %% LAYER 5 — CONTRACT RELEASE
    %% ============================
    L --> M[Transfer token từ Contract → Ví CDS]

    %% ============================
    %% LAYER 6 — CHANNEL RESULT
    %% ============================
    M --> N[MS-CDS trả kết quả CDS + thông tin ví]
    N --> O[Channel hiển thị CDS cho User]

    %% ============================
    %% OPTIONAL — LOGGING
    %% ============================
    J --> LOG[Ghi log hạch toán]
    LOG --> LOG
```

## Sequence Diagram

```mermaid
sequenceDiagram
    autonumber

    participant User as User
    participant UI as Channel/WebApp
    participant SC as VND Stablecoin Contract
    participant MP as CDS Issuance Contract
    participant MS as MS-CDS Sơ cấp
    participant AC as Core Accounting
    participant WAL as CDS Wallet (Custody)
    participant LOG as Logging Service

    %% ============================
    %% 1. USER GỬI YÊU CẦU PHÁT HÀNH
    %% ============================
    User->>UI: Yêu cầu phát hành CDS (amount, tenor, product)
    UI->>MP: submitIssuanceRequest(assetId, amount, tenor)

    %% ============================
    %% 2. LOCK STABLECOIN ON-CHAIN
    %% ============================
    MP->>SC: lockStableVND(user → contract, amount)
    SC-->>MP: Lock OK (txHash)
    MP-->>UI: Trả txHash lock token thành công

    %% ============================
    %% 3. GỌI MS-CDS XỬ LÝ NGHIỆP VỤ
    %% ============================
    UI->>MS: confirmLock(assetId, amount, txHash)
    MS->>MS: Validate dữ liệu CDS
    MS->>MS: Tạo CDS sơ cấp (principal, kỳ hạn, lãi suất)
    MS->>MS: Auto-approve phát hành

    %% ============================
    %% 4. HẠCH TOÁN PHÁT HÀNH
    %% ============================
    MS->>AC: Hạch toán phát hành CDS\n(Dr stablecoin ledger, Cr tài khoản phát hành)
    AC-->>MS: Hạch toán thành công

    %% ============================
    %% 5. RELEASE / TRANSFER STABLECOIN
    %% ============================
    MS->>MP: releaseFundsToCDWallet(amount)
    MP->>SC: transfer(contract → WAL, amount)
    SC-->>WAL: Stablecoin chuyển về ví CDS/Lưu ký

    %% ============================
    %% 6. TRẢ KẾT QUẢ CHO USER
    %% ============================
    MS-->>UI: CDS issued successfully + CDS info
    UI-->>User: Hiển thị CDS + thông tin ví + txHash

    %% ============================
    %% 7. LOGGING
    %% ============================
    AC->>LOG: Ghi log hạch toán
    LOG-->>LOG: stored
```
