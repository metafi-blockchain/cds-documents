# 1. Luồng tạo CDS với phê duyệt

## Người tạo CDS

1. Nhập bộ dữ liệu CDS và để hệ thống tự động validate
2. Sinh metadata JSON từ dữ liệu hợp lệ
3. Upload metadata lên IPFS để lấy CID
4. Lưu bản ghi ở trạng thái `Nháp`, kèm CID
5. Thực hiện thao tác gửi yêu cầu phê duyệt

## Người phê duyệt

6. Rà soát lại toàn bộ dữ liệu và chứng từ đi kèm
7. Nếu đồng ý phê duyệt:
   - Gọi contract để đúc token CDS
   - Lưu lại `contractAddress` và `tokenId`
   - Ghi log giao dịch
   - Cập nhật trạng thái sang `Đã phê duyệt`
   - Gửi email thông báo kết quả
8. Nếu từ chối: cập nhật trạng thái `Rejected` và gửi email thông báo lý do

## Follow Diagram
```mermaid
flowchart TD

    %% --- Maker Flow ---
    A1[Người tạo CDS<br>Nhập dữ liệu] --> A2{Validate dữ liệu?}

    A2 -->|Không hợp lệ| A3[Trả lỗi<br>Yêu cầu nhập lại] --> A1
    A2 -->|Hợp lệ| A4[Tạo metadata JSON]

    A4 --> A5[Upload metadata lên IPFS]
    A5 --> A6[Nhận CID / IPFS Link]

    A6 --> A7[Lưu trạng thái = Nháp<br>Lưu IPFS CID]
    A7 --> A8[Gửi phê duyệt]

    %% --- Move to Approver ---
    A8 --> B1[Chuyển trạng thái = Chờ phê duyệt]
    B1 --> B2[Người phê duyệt nhận hồ sơ]

    %% --- Approver Flow ---
    B2 --> B3[Kiểm tra dữ liệu & thông tin]
    B3 --> B4{Phê duyệt?}

    %% --- Approve path ---
    B4 -->|Yes| C1[Gọi Contract Cds<br>Tạo token CDS]
    C1 --> C2[Nhận contractAddress / tokenId]
    C2 --> C3[Lưu contractAddress + tokenId]
    C3 --> C4[Lưu log giao dịch]
    C4 --> C5[Chuyển trạng thái = Đã phê duyệt]
    C5 --> C6[Gửi notify email]

    %% --- Reject path ---
    B4 -->|No| D1[Chuyển trạng thái = Rejected] --> D2[Gửi notify email]
```

## Sequence Diagram

```mermaid
sequenceDiagram
    autonumber

    participant User as Người tạo CDS
    participant Asset as CDS Service
    participant IPFS as IPFS Storage
    participant Approver as Người phê duyệt
    participant Chain as Contract CDS (Blockchain)
    participant Mail as Mail Service

    %% --- Người tạo nhập liệu ---
    User->>Asset: Nhập dữ liệu CDS
    Asset->>Asset: Validate dữ liệu

    alt Dữ liệu không hợp lệ
        Asset-->>User: Trả lỗi & yêu cầu cập nhật lại
        User->>Asset: Nhập lại dữ liệu
        Asset->>Asset: Validate lại
    end

    %% --- Tạo & upload metadata ---
    Asset->>Asset: Tạo metadata JSON
    Asset->>IPFS: Upload metadata
    IPFS-->>Asset: Trả về CID / IPFS URL

    %% --- Lưu trạng thái nháp ---
    Asset->>Asset: Lưu trạng thái = "Nháp"\n(kèm IPFS CID)

    %% --- Gửi phê duyệt ---
    User->>Asset: Gửi phê duyệt
    Asset->>Asset: Chuyển trạng thái = "Chờ phê duyệt"

    %% --- Checker kiểm duyệt ---
    Asset->>Approver: Gửi hồ sơ CDS cần phê duyệt
    Approver->>Approver: Check dữ liệu & thông tin

    alt Phê duyệt = Yes
        Approver->>Asset: Đồng ý phê duyệt
        Asset->>Chain: Gọi contract CDS\n→ tạo token đại diện
        Chain-->>Asset: Trả về tokenId / contractAddress

        Asset->>Asset: Lưu contractAddress + tokenId
        Asset->>Asset: Lưu log giao dịch
        Asset->>Asset: Chuyển trạng thái = "Đã phê duyệt"

        Asset->>Mail: Gửi notify email cho Maker
        Mail-->>Asset: Email sent
    else Phê duyệt = No
        Approver->>Asset: Từ chối
        Asset->>Asset: Chuyển trạng thái = "Rejected"
        Asset->>Mail: Gửi notify email từ chối
    end
```
