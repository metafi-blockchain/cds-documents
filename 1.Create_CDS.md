# 1. Luồng tạo CDS với phê duyệt

## Người tạo CDS

1. Nhập dữ liệu CDS để hệ thống kiểm tra tính hợp lệ.
2. Tạo metadata JSON từ dữ liệu đã nhập.
3. Upload metadata lên IPFS và nhận về CID.
4. Lưu bản ghi với trạng thái `Nháp`.
5. Gửi yêu cầu phê duyệt hồ sơ.

## Người phê duyệt

6. Kiểm tra lại toàn bộ thông tin hồ sơ.
7. Nếu phê duyệt:
   - Gọi contract để tạo token CDS.
   - Ghi lại `contractAddress` và `tokenId`.
   - Lưu log giao dịch.
   - Cập nhật trạng thái hồ sơ.
   - Gửi email thông báo đã phê duyệt.
8. Nếu từ chối: đổi trạng thái sang `Rejected` và gửi email thông báo từ chối.

## Sequence Diagram

```mermaid
sequenceDiagram
    autonumber

    participant User as Người tạo CDS
    participant Asset as CDS Service
    participant IPFS as IPFS Storage
    participant Approver as Người phê duyệt
    participant Chain as Contract CDS (Blockchain)
    participant Mail as Mail Service

    %% --- Người tạo nhập liệu ---
    User->>Asset: Nhập dữ liệu CDS
    Asset->>Asset: Validate dữ liệu

    alt Dữ liệu không hợp lệ
        Asset-->>User: Trả lỗi & yêu cầu cập nhật lại
        User->>Asset: Nhập lại dữ liệu
        Asset->>Asset: Validate lại
    end

    %% --- Tạo & upload metadata ---
    Asset->>Asset: Tạo metadata JSON
    Asset->>IPFS: Upload metadata
    IPFS-->>Asset: Trả về CID / IPFS URL

    %% --- Lưu trạng thái nháp ---
    Asset->>Asset: Lưu trạng thái = "Nháp"\n(kèm IPFS CID)

    %% --- Gửi phê duyệt ---
    User->>Asset: Gửi phê duyệt
    Asset->>Asset: Chuyển trạng thái = "Chờ phê duyệt"

    %% --- Checker kiểm duyệt ---
    Asset->>Approver: Gửi hồ sơ CDS cần phê duyệt
    Approver->>Approver: Check dữ liệu & thông tin

    alt Phê duyệt = Yes
        Approver->>Asset: Đồng ý phê duyệt
        Asset->>Chain: Gọi contract CDS\n→ tạo token đại diện
        Chain-->>Asset: Trả về tokenId / contractAddress

        Asset->>Asset: Lưu contractAddress + tokenId
        Asset->>Asset: Lưu log giao dịch
        Asset->>Asset: Chuyển trạng thái = "Đã phê duyệt"

        Asset->>Mail: Gửi notify email cho Maker
        Mail-->>Asset: Email sent
    else Phê duyệt = No
        Approver->>Asset: Từ chối
        Asset->>Asset: Chuyển trạng thái = "Rejected"
        Asset->>Mail: Gửi notify email từ chối
    end
```
